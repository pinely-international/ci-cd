name: Build & Deploy

on:
  workflow_call:
    inputs:
      ENV_NAME:
        type: string
        required: true
      DEPLOY_DIRECTORY:
        type: string
        required: false
      PM2_PROCESS_NAME:
        type: string
        required: false
    secrets:
      DEPLOY_HOST:
        required: true
      DEPLOY_USERNAME:
        required: true
      DEPLOY_PORT:
        required: false
      DEPLOY_SSH_KEY:
        required: true

jobs:
  build:
    name: build-app
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install bun
        uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install
      - name: Build application
        run: bun run build
      - name: Run tests
        run: bun test --pass-with-no-tests

      - name: Package with bun pm pack --quiet (capture filename)
        run: |
          ARCHIVE=$(bun pm pack --quiet | tr -d '\n')
          echo "ARCHIVE=$ARCHIVE" >> $GITHUB_ENV
          echo "Created archive: $ARCHIVE"

      - name: Set DEPLOY_DIRECTORY env
        run: |
          DEPLOY_DIRECTORY="${{ inputs.DEPLOY_DIRECTORY || format('/home/{0}', secrets.DEPLOY_USERNAME) }}"
          echo "DEPLOY_DIRECTORY=$DEPLOY_DIRECTORY" >> $GITHUB_ENV

      - name: Copy bundle to remote
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USERNAME }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          source: "${{ env.ARCHIVE }}"
          target: "${{ env.DEPLOY_DIRECTORY }}/releases/"

      - name: Deploy on remote and reload PM2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USERNAME }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || '22' }}
          script: |
            set -euo pipefail

            DEPLOY_DIR="${{ env.DEPLOY_DIRECTORY }}"
            RELEASES_DIR="$DEPLOY_DIR/releases"
            ARCHIVE_NAME="${{ env.ARCHIVE }}"

            REPO_FULL="${{ github.repository }}"
            REPO_NAME="${REPO_FULL##*/}"

            if [ -n "${{ inputs.PM2_PROCESS_NAME }}" ]; then
              PM2_PROCESS_NAME="${{ inputs.PM2_PROCESS_NAME }}"
            else
              PM2_PROCESS_NAME="${REPO_NAME}-${{ inputs.ENV_NAME }}"
            fi

            cd "$RELEASES_DIR"
            tar -xzf "$ARCHIVE_NAME"
            rm -f "$ARCHIVE_NAME"

            # Install bun (idempotent) and ensure it is on PATH
            curl -fsSL https://bun.sh/install | bash
            # bun installer puts bin in ~/.bun/bin; ensure PATH
            export PATH="$HOME/.bun/bin:$PATH"

            # Ensure pm2 is installed (install globally if missing)
            if ! command -v pm2 >/dev/null 2>&1; then
              # prefer pnpm/npm/yarn depending on your remote environment; use npm here
              bun i -g pm2 --silent
            fi

            SCRIPT_PATH=$(bun --silent -e "console.log(require('./package.json').main || '')" || true)

            if pm2 describe "$PM2_PROCESS_NAME" >/dev/null 2>&1; then
              pm2 restart "$PM2_PROCESS_NAME"
            else
              pm2 start "bun $SCRIPT_PATH" --name "$PM2_PROCESS_NAME"
            fi
